/** === الإعدادات العامة === **/
const SHEET_NAME = 'orders';
const ADMIN_TOKEN = 'Mohamad&03'; // بدّله حسب رغبتك

/** === Utilities === **/
function getSheet_() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
  // تأكد من وجود رؤوس
  const headers = ['orderId','status','fullName','phone','email','notes','updatedAt'];
  const firstRow = sh.getRange(1,1,1,headers.length).getValues()[0];
  if (firstRow.join('') === '') {
    sh.getRange(1,1,1,headers.length).setValues([headers]);
  }
  return sh;
}

function findRowByOrderId_(orderId){
  const sh = getSheet_();
  const last = sh.getLastRow();
  if (last < 2) return { row: -1, data: null };
  const range = sh.getRange(2,1,last-1,7).getValues();
  for (let i=0;i<range.length;i++){
    if (String(range[i][0]).trim() === String(orderId).trim()){
      return { row: i+2, data: range[i] };
    }
  }
  return { row: -1, data: null };
}

function toObject_(arr){
  const [orderId,status,fullName,phone,email,notes,updatedAt] = arr;
  return { orderId, status, fullName, phone, email, notes, updatedAt };
}

function jsonResponse_(obj, callback){
  const body = JSON.stringify(obj);
  const mime = callback ? ContentService.MimeType.JAVASCRIPT : ContentService.MimeType.JSON;
  const content = callback ? `${callback}(${body});` : body;
  const out = ContentService.createTextOutput(content).setMimeType(mime);
  // تلميحات عدم الكاش + CORS (للـ fetch)
  const resp = HtmlService.createHtmlOutput('').getResponse();
  resp.setHeader('Access-Control-Allow-Origin','*');
  resp.setHeader('Access-Control-Allow-Headers','Content-Type');
  resp.setHeader('Access-Control-Allow-Methods','GET,POST,OPTIONS');
  resp.setHeader('Cache-Control','no-store, max-age=0');
  // Apps Script لا يرجّع Response مباشرة من ContentService،
  // لكن الهيدرز أعلاه تفيد مع HtmlService؛ أما هنا نرجّع ContentService فقط.
  return out;
}

/** === GET (قراءة / JSONP / upsert عبر GET) ===
 * أمثلة:
 *  - قراءة:  GET ?id=SH-123
 *  - upsert: GET ?action=upsert&token=...&orderId=...&status=...&fullName=...&...
 *  - JSONP:  أضف callback=cbName
 */
function doGet(e){
  try{
    const p = e.parameter || {};
    const cb = p.callback; // JSONP?
    const action = (p.action||'').toLowerCase();

    if (action === 'upsert') {
      // upsert عبر GET (fallback)
      if (p.token !== ADMIN_TOKEN) {
        return jsonResponse_({ ok:false, error:'unauthorized' }, cb);
      }
      const oid = (p.orderId||'').trim();
      if (!oid) return jsonResponse_({ ok:false, error:'orderId required' }, cb);

      const payload = {
        status: (p.status||'received').trim(),
        fullName: (p.fullName||'').trim(),
        phone: (p.phone||'').trim(),
        email: (p.email||'').trim(),
        notes: (p.notes||'').trim()
      };
      const out = upsert_(oid, payload);
      return jsonResponse_({ ok:true, updated: true, orderId: oid, row: out.row }, cb);
    }

    // قراءة
    const oid = (p.id||'').trim();
    if (!oid) {
      return jsonResponse_({ ok:false, error:'missing id' }, cb);
    }
    const sh = getSheet_();
    const found = findRowByOrderId_(oid);
    if (found.row === -1) {
      return jsonResponse_({ ok:true, found:false }, cb);
    }
    const obj = toObject_(found.data);
    return jsonResponse_({ ok:true, found:true, order: obj }, cb);

  }catch(err){
    return jsonResponse_({ ok:false, error:String(err) });
  }
}

/** === POST (حفظ) ===
 * يقبل application/x-www-form-urlencoded لتجنب preflight
 * الحقول:
 *  token, orderId, status, fullName, phone, email, notes
 */
function doPost(e){
  try{
    const p = (e.parameter||{});
    if (p.token !== ADMIN_TOKEN) {
      return jsonResponse_({ ok:false, error:'unauthorized' });
    }
    const oid = (p.orderId||'').trim();
    if (!oid) return jsonResponse_({ ok:false, error:'orderId required' });

    const payload = {
      status: (p.status||'received').trim(),
      fullName: (p.fullName||'').trim(),
      phone: (p.phone||'').trim(),
      email: (p.email||'').trim(),
      notes: (p.notes||'').trim()
    };

    const out = upsert_(oid, payload);
    return jsonResponse_({ ok:true, updated:true, orderId: oid, row: out.row });

  }catch(err){
    return jsonResponse_({ ok:false, error:String(err) });
  }
}

/** === منطق الحفظ === **/
function upsert_(orderId, payload){
  const sh = getSheet_();
  const now = new Date();
  const found = findRowByOrderId_(orderId);
  const rowData = [
    orderId,
    payload.status || 'received',
    payload.fullName || '',
    payload.phone || '',
    payload.email || '',
    payload.notes || '',
    now
  ];

  if (found.row === -1) {
    // إضافة
    const r = sh.appendRow(rowData);
    const newRow = sh.getLastRow();
    return { mode:'insert', row:newRow };
  } else {
    // تحديث
    sh.getRange(found.row, 1, 1, rowData.length).setValues([rowData]);
    return { mode:'update', row:found.row };
  }
}
