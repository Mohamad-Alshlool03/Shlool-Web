<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Shlool Web</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --surface:#12141a; --text:#e9ecf1; --muted:#b7c0cc;
      --border:rgba(255,255,255,.08); --radius:16px; --accent:#0a84ff; --max:1050px;
      --shadow:0 12px 36px rgba(0,0,0,.45);
      --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(1400px 900px at 75% -200px, rgba(64,179,255,.12), transparent 60%),
        linear-gradient(180deg, #0c0e13, var(--bg));
    }
    .topbar{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(10px);
      background:linear-gradient(90deg, color-mix(in oklab, var(--accent) 22%, transparent), transparent);
      border-bottom:1px solid var(--border); padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .topbar .brand{display:flex; align-items:center; gap:10px; font-weight:800}
    .wrap{max-width:var(--max); margin:auto; padding:24px 18px 38px}
    .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .row{display:grid; grid-template-columns:180px 1fr auto; gap:10px; align-items:center; margin-bottom:10px}
    label{font-weight:800}
    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#101318; color:var(--text); font:inherit; outline:none;
    }
    textarea{min-height:110px; resize:vertical; line-height:1.7}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(135deg,var(--accent),color-mix(in oklab, var(--accent) 60%, #40b3ff)); color:#fff; font-weight:800; text-decoration:none; cursor:pointer;
    }
    .ghost{background:transparent; color:var(--text)}
    .ok{background:linear-gradient(135deg,var(--green),#58d08a); border-color:rgba(34,197,94,.35)}
    .warn{background:linear-gradient(135deg,var(--amber),#ffd166); border-color:rgba(245,158,11,.35); color:#0b0f16}
    .danger{background:linear-gradient(135deg,var(--red),#ff7b7b); border-color:rgba(239,68,68,.35)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); font-weight:800}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    small.muted{color:var(--muted)}
    .two{display:grid; grid-template-columns:1.05fr .95fr; gap:16px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} .row{grid-template-columns:1fr} }
    .toast{
      position:fixed; inset:auto 16px 16px auto; z-index:50; background:#0e1117; color:#fff;
      border:1px solid var(--border); border-radius:12px; padding:10px 14px; box-shadow:var(--shadow);
      opacity:0; transform:translateY(8px); transition:opacity .25s, transform .25s;
    }
    .toast.show{opacity:1; transform:translateY(0)}
    .gate{display:grid; place-items:center; min-height:45vh}
    .gate .panel{max-width:520px}
    button:disabled{opacity:.6; cursor:not-allowed}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 25%, transparent)"></span>
      Shlool Web â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    </div>
    <div class="pill">exec: <span class="mono" style="font-size:12px">Apps Script</span></div>
  </div>

  <main class="wrap" id="app" hidden>
    <section class="panel">
      <div class="row" style="grid-template-columns:160px 1fr auto">
        <label for="orderId">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
        <input id="orderId" class="mono" placeholder="SH-YYMMDD-ABCDE" dir="ltr">
        <div class="btns">
          <button class="btn" id="loadBtn">Ø¬Ù„Ø¨</button>
          <button class="btn ghost" id="copyIdBtn">Ù†Ø³Ø®</button>
          <a class="btn ghost" id="openTrack" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ØªØªØ¨Ù‘Ø¹</a>
        </div>
      </div>

      <div class="two">
        <div class="panel" style="background:var(--surface)">
          <h3 style="margin-top:0">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
          <div class="row"><label for="fullName">Ø§Ù„Ø§Ø³Ù…</label><input id="fullName" placeholder="Full name"><div></div></div>
          <div class="row"><label for="phone">Ø§Ù„Ù‡Ø§ØªÙ/ÙˆØ§ØªØ³Ø§Ø¨</label><input id="phone" placeholder="07X XXX XXXX"><div></div></div>
          <div class="row"><label for="email">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="email" type="email" placeholder="example@email.com" dir="ltr"><div></div></div>
          <div class="row"><label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©</label><textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°/Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©â€¦"></textarea><div></div></div>
          <div class="btns">
            <button class="btn ok" id="saveBtn">Ø­ÙØ¸ / ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn ghost" id="copyWhatsApp">Ù†Ø³Ø® Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</button>
          </div>
          <small class="muted">Ø§Ù„Ø­ÙØ¸ ÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø´ÙŠØª ÙÙˆØ±Ù‹Ø§ Ø¹Ø¨Ø± Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨.</small>
        </div>

        <div class="panel" style="background:var(--surface)">
          <h3 style="margin-top:0">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
          <div class="row" style="grid-template-columns:160px 1fr">
            <label for="status">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="status">
              <option value="received">received â€” ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
              <option value="reviewing">reviewing â€” ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
              <option value="quoted">quoted â€” Ø£ÙØ±Ø³Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</option>
              <option value="started">started â€” Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
              <option value="done">done â€” Ø§ÙƒØªÙ…Ù„</option>
              <option value="cancelled">cancelled â€” Ø£ÙÙ„ØºÙÙŠ</option>
            </select>
          </div>
          <div class="btns">
            <button class="btn warn" data-status="reviewing">ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
            <button class="btn" data-status="quoted">Ø£Ø±Ø³Ù„Ù†Ø§ Ø§Ù„Ø¹Ø±Ø¶</button>
            <button class="btn" data-status="started">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
            <button class="btn ok" data-status="done">Ø¥Ù†Ù‡Ø§Ø¡</button>
            <button class="btn danger" data-status="cancelled">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
          <div class="btns" style="margin-top:8px">
            <button class="btn ghost" id="refreshBtn">ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø´ÙŠØª</button>
            <button class="btn ghost" id="copyTrack">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ù‘Ø¹</button>
          </div>
          <small class="muted">Ø²Ø±Ù‘ Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø«Ù… ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>
        </div>
      </div>
    </section>
  </main>

  <!-- Ø¨ÙˆØ§Ø¨Ø© PIN Ø¨Ø³ÙŠØ·Ø© (ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·) -->
  <section class="gate" id="gate">
    <div class="panel">
      <h2 style="margin:0 0 8px">Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
      <p class="muted" style="margin:0 0 12px">Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
      <div class="row" style="grid-template-columns:160px 1fr auto">
        <label for="pin">Admin PIN</label>
        <input id="pin" type="password" inputmode="text" autocomplete="off" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" dir="ltr">
        <button class="btn" id="enterBtn">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <small class="muted">Ù‡Ø°Ø§ Ù‚ÙÙ„ ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ØªØªÙ… Ø¨Ù‡ÙŠØ¯Ø± Ø§Ù„Ø·Ù„Ø¨ (TOKEN).</small>
    </div>
  </section>

  <div class="toast" id="toast"></div>

  <script>
    // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Web App ===
    const WEB_APP_URL   = 'https://script.google.com/macros/s/AKfycbwDYQZgMCa3OGXNLvtNGJ9KDeI06AthQKpWrip27puCvDI7St9O3OExaekI3in1pH9brw/exec';
    const WEB_APP_TOKEN = 'Mohamad&03';

    // Ù…Ø³Ø§Ø¹Ø¯Ø©
    const $ = id => document.getElementById(id);
    const toast = $('toast'); let tTimer;
    function notify(msg){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(tTimer); tTimer=setTimeout(()=>toast.classList.remove('show'),2200); }

    // Ù‚ÙÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·
    const GATE_KEY = 'adminKey';
    function openApp(){ $('gate').hidden = true; $('app').hidden = false; }
    $('enterBtn').addEventListener('click', ()=>{
      const v = $('pin').value.trim();
      if(!v){ notify('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ PIN'); return; }
      if(v !== WEB_APP_TOKEN){ notify('PIN ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
      sessionStorage.setItem(GATE_KEY, v); openApp(); prefillAndAutoload();
    });
    if(sessionStorage.getItem(GATE_KEY) === WEB_APP_TOKEN){ openApp(); }

    // ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· ØªØªØ¨Ù‘Ø¹
    function trackUrl(oid){
      const base = location.pathname.replace(/[^/]+$/, '');
      return `${location.origin}${base}track.html?id=${encodeURIComponent(oid)}`;
    }

    // Prefill Ù…Ù† ?id= Ø£Ùˆ Ø¢Ø®Ø± Ø±Ù‚Ù… ØªÙ… Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡ + Ø¬Ù„Ø¨ ÙÙˆØ±ÙŠ
    function prefillAndAutoload(){
      const p = new URLSearchParams(location.search);
      const fromUrl = p.get('id');
      const last = sessionStorage.getItem('lastOrderId') || '';
      if(fromUrl){ $('orderId').value = fromUrl; }
      else if(last){ $('orderId').value = last; }
      if($('orderId').value.trim()) { loadOrder(); }
    }
    // Ù„Ùˆ ÙƒØ§Ù† Ù…ÙØªÙˆØ­ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø¨Ø¯ÙˆÙ† Ø¨ÙˆØ§Ø¨Ø©
    if(!$('gate').hidden){} else { prefillAndAutoload(); }

    // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨ (Ù…Ø¹ ÙƒØ´Ù Ø£Ø®Ø·Ø§Ø¡ Ø£ÙØ¶Ù„ ÙˆÙ…Ù†Ø¹ Ø§Ù„ÙƒØ§Ø´)
    async function loadOrder(){
      const oid = $('orderId').value.trim();
      if(!oid){ notify('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'); return; }
      try{
        const res = await fetch(`${WEB_APP_URL}?id=${encodeURIComponent(oid)}`, {
          method:'GET', mode:'cors', cache:'no-store'
        });
        const text = await res.text();
        let data; try{ data = JSON.parse(text); }
        catch(e){ console.error('Raw response:', text); notify('Ø±Ø¯ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…'); return; }

        if(!data.ok){ notify(data.error ? `Ø®Ø·Ø£: ${data.error}` : 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¬Ù„Ø¨'); return; }
        if(!data.found){ notify('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

        const o = data.order || {};
        $('status').value = String(o.status||'received');
        $('fullName').value = o.fullName||'';
        $('phone').value = o.phone||'';
        $('email').value = o.email||'';
        $('notes').value = o.notes||'';
        $('openTrack').href = trackUrl(oid);

        sessionStorage.setItem('lastOrderId', oid);
        notify('ØªÙ… Ø§Ù„Ø¬Ù„Ø¨ âœ…');
      }catch(err){
        console.error(err);
        notify('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ (ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø´Ø± Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨)');
      }
    }

    // Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ« (Ù…Ø¹ Ù…Ù‡Ù„Ø© ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£)
    async function saveOrder(){
      const oid = $('orderId').value.trim();
      if(!oid){ notify('Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ø·Ù„ÙˆØ¨'); return; }

      const payload = {
        token: WEB_APP_TOKEN,
        orderId: oid,
        status: $('status').value,
        fullName: $('fullName').value.trim(),
        phone: $('phone').value.trim(),
        email: $('email').value.trim(),
        notes: $('notes').value.trim()
      };

      const btn = $('saveBtn'); const old = btn.textContent; btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦';

      const ctl = new AbortController(); const timeout = setTimeout(()=>ctl.abort(), 12000);

      try{
        const res = await fetch(WEB_APP_URL, {
          method: 'POST', mode: 'cors', signal: ctl.signal,
          headers: { 'Content-Type': 'application/json', 'x-shlool-key': WEB_APP_TOKEN },
          body: JSON.stringify(payload)
        });
        clearTimeout(timeout);
        const text = await res.text();
        let out; try{ out = JSON.parse(text); }
        catch(e){ console.error('Raw response:', text); notify('Ø±Ø¯ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…'); return; }

        if(!out.ok){ notify(out.error ? `ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ${out.error}` : 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'); return; }

        sessionStorage.setItem('lastOrderId', oid);
        notify('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
      }catch(err){
        if(err.name === 'AbortError'){ notify('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø© â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„'); }
        else{ console.error(err); notify('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„'); }
      }finally{
        btn.disabled = false; btn.textContent = old;
      }
    }

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (ØªØºÙŠÙ‘Ø± + Ø­ÙØ¸ + Ø¬Ù„Ø¨ Ù„Ù„ØªØ£ÙƒÙŠØ¯)
    document.querySelectorAll('[data-status]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        $('status').value = btn.dataset.status;
        await saveOrder();
        loadOrder();
      });
    });

    // Ø£Ø²Ø±Ø§Ø± Ù…ØªÙ†ÙˆØ¹Ø©
    $('loadBtn').addEventListener('click', loadOrder);
    $('saveBtn').addEventListener('click', saveOrder);

    $('copyIdBtn').addEventListener('click', async ()=>{
      const oid = $('orderId').value.trim(); if(!oid){ notify('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'); return; }
      try{ await navigator.clipboard.writeText(oid); notify('Ù†ÙØ³Ø® Ø§Ù„Ø±Ù‚Ù…'); }catch{ notify('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); }
    });

    $('copyTrack').addEventListener('click', async ()=>{
      const oid = $('orderId').value.trim(); if(!oid){ notify('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'); return; }
      try{ await navigator.clipboard.writeText(trackUrl(oid)); notify('Ù†ÙØ³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ù‘Ø¹'); }catch{ notify('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); }
    });

    $('openTrack').addEventListener('click', (e)=>{
      const oid = $('orderId').value.trim();
      if(!oid){ e.preventDefault(); notify('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù…'); }
      else{ $('openTrack').href = trackUrl(oid); }
    });

    $('refreshBtn').addEventListener('click', loadOrder);

    // Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„
    $('copyWhatsApp').addEventListener('click', async ()=>{
      const name = $('fullName').value.trim() || 'Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„ÙƒØ±ÙŠÙ…';
      const st = $('status').value;
      const oid = $('orderId').value.trim();
      const map = {
        received:'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ âœ…',
        reviewing:'Ø·Ù„Ø¨Ùƒ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ”',
        quoted:'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ğŸ“',
        started:'Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ° ğŸš€',
        done:'Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸ‰',
        cancelled:'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨'
      };
      const msg = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${name} ğŸ‘‹\n\nØ¨Ø®ØµÙˆØµ Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… ${oid}:\n${map[st]||map.received}\n\nØ±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ù‘Ø¹:\n${trackUrl(oid)}\n\nØ£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ù†Ø§ Ø­Ø§Ø¶Ø±.`;
      try{ await navigator.clipboard.writeText(msg); notify('Ù†ÙØ³Ø®Øª Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨'); }catch{ notify('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); }
    });
  </script>
</body>
</html>
