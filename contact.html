<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>اطلب موقعك — Shlool Web</title>
  <meta name="description" content="اطلب موقعك الآن: اختر الميزات والمدة. نرجع لك بعرض خلال وقت قصير.">
  <meta name="color-scheme" content="dark light">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#1f1f1f; --card:#262626; --surface:#202020;
      --blue:#0a84ff; --blue-2:#40b3ff;
      --whatsapp:#25D366; --whatsapp-2:#128C7E;
      --ig1:#f58529; --ig2:#dd2a7b; --ig3:#8134af; --ig4:#515bd4;
      --text:#e9ecf1; --muted:#b7c0cc;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px; --max:1100px;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0; font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 80% -100px, rgba(64,179,255,.12), transparent 60%),
        linear-gradient(180deg, #1b1b1b, var(--bg));
      color:var(--text); line-height:1.7; color-scheme:dark;
    }
    a{color:var(--blue); text-decoration:none}
    img{max-width:100%; height:auto; display:block}
    header{
      position:sticky; top:0; backdrop-filter:saturate(1.2) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.0));
      border-bottom:1px solid rgba(255,255,255,.08);
      z-index:40; box-shadow:0 6px 20px rgba(0,0,0,.25);
    }
    .nav{max-width:var(--max); margin:auto; padding:14px 20px; display:flex; align-items:center; gap:16px}
    .logo{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px; color:var(--text)}
    .logo-img{height:52px; width:auto; border-radius:10px; box-shadow:var(--shadow)}
    .nav-gap{margin-inline-start:auto}

    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px;
      background:linear-gradient(135deg,var(--blue),var(--blue-2)); color:#fff; font-weight:700;
      box-shadow:var(--shadow); transition:transform .15s ease, box-shadow .2s ease; border:0; cursor:pointer; text-align:center;
    }
    .btn:hover{transform:translateY(-2px); box-shadow:0 16px 40px rgba(10,132,255,.25)}
    .btn-outline{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.16)}
    .btn-whatsapp{background:linear-gradient(135deg,var(--whatsapp),var(--whatsapp-2)); color:#fff}
    .btn-ig{background:linear-gradient(135deg,var(--ig4),var(--ig3),var(--ig2),var(--ig1)); color:#fff}

    .wrap{max-width:var(--max); margin:auto; padding:28px 20px}
    .hero{display:grid; grid-template-columns:1.1fr .9fr; gap:28px; align-items:center; padding-block:32px}
    .hero > *{min-width:0}
    .title{font-size:clamp(30px, 4vw, 46px); line-height:1.2; margin:0 0 10px; font-weight:800}
    .subtitle{color:var(--muted); font-size:clamp(16px,2.3vw,18px); margin:0 0 20px}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      background:rgba(10,132,255,.12); color:var(--blue); font-weight:700; margin-bottom:14px;
      border:1px solid rgba(64,179,255,.25)}
    .panel{background:var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .grid-2{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
    .grid-3{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px}
    label{font-weight:700; margin-bottom:6px; display:block}

    input:not([type="checkbox"]):not([type="radio"]), select, textarea{
      width:100%; min-width:0; padding:12px 12px; border-radius:12px; background:#1f1f1f;
      border:1px solid rgba(255,255,255,.08); color:var(--text); font:inherit; outline:none;
      transition:border-color .15s ease, box-shadow .15s ease; font-size:16px;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--blue); box-shadow:0 0 0 3px rgba(10,132,255,.15)}
    .hint{color:var(--muted); font-size:13px; margin-top:6px}

    .choices{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .choices label{
      font-weight:600; display:flex; align-items:center; gap:10px; line-height:1.6;
      padding:10px 12px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:rgba(255,255,255,.02);
    }
    .choices input[type="checkbox"]{ width:18px; height:18px; accent-color:var(--blue) }

    .actions{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-start; margin-top:14px}
    .estimator{display:flex; align-items:center; justify-content:space-between; gap:14px}
    .estimate-pill{ padding:8px 12px; border-radius:999px; background:rgba(10,132,255,.12);
      border:1px solid rgba(64,179,255,.25); color:#fff; font-weight:800 }
    .small{color:var(--muted); font-size:13px}

    footer{ background:var(--surface); border-top:1px solid rgba(255,255,255,.08);
      box-shadow:0 -6px 20px rgba(0,0,0,.25); margin-top:40px; }
    .footer-inner{max-width:var(--max); margin:auto; padding:22px 20px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .brand{opacity:.7}
    .dev{font-weight:800}

    .reveal{opacity:0; transform:translateY(16px); transition:opacity .6s ease, transform .6s ease}
    .reveal.show{opacity:1; transform:none}

    @media (prefers-reduced-motion: reduce){
      html{scroll-behavior:auto}
      .reveal{transition:none}
    }

    /* HoneyPot */
    #siteForm{ position:relative }
    .hp-trap{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0 0 0 0); clip-path:inset(50%);
      border:0; white-space:nowrap; opacity:0;
    }

    .agree{ display:flex; align-items:center; gap:8px; font-weight:600 }
    .agree input[type="checkbox"]{ width:auto; height:auto; margin:0 }
    .invalid{ border-color:#ff6b6b !important; box-shadow:0 0 0 3px rgba(255,107,107,.15) }

    @media (max-width:900px){
      .hero{grid-template-columns:1fr; gap:18px}
      .grid-2,.grid-3{grid-template-columns:1fr}
      .choices{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="logo">
        <img class="logo-img" src="cover.jpg" alt="Shlool Web">
        <span>Shlool <span style="color:var(--blue)">Web</span></span>
      </div>
      <div class="nav-gap"></div>
      <a class="btn btn-outline" href="index.html" aria-label="العودة للرئيسية" rel="noopener">العودة للرئيسية</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="hero">
      <div>
        <div class="badge">طلب موقع جديد ✨</div>
        <h1 class="title">خلّينا نبني لك موقع <span style="color:var(--blue)">يناسب بزنسك</span></h1>
        <p class="subtitle">عبّي الطلب أدناه — نراجع التفاصيل ونرجع لك بعرض سعر وخطة عمل خلال وقت قصير.</p>
        <div class="actions" style="margin-top:10px">
          <a class="btn btn-whatsapp" href="https://wa.me/962790986908" target="_blank" rel="noopener">تواصل واتساب</a>
          <a class="btn btn-ig" href="https://instagram.com/shlool_web" target="_blank" rel="noopener" aria-label="التواصل عبر إنستجرام">إنستجرام</a>
          <a class="btn" href="mailto:mshlool684@gmail.com">راسلني عبر الإيميل</a>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 10px">ليش معنا؟</h3>
        <ul style="margin:0; padding-inline-start:18px; color:var(--muted)">
          <li>تسليم خلال أقل من أسبوع للمواقع الصغيرة.</li>
          <li>تصميم متوافق مع الجوال وسريع الأداء.</li>
          <li>نماذج تواصل تصل للإيميل + زر واتساب مباشر.</li>
          <li>إعداد دومين واستضافة (اختياري).</li>
        </ul>
      </div>
    </section>

    <!-- نموذج طلب موقع -->
    <section class="panel reveal" aria-label="طلب موقع">
      <h2 style="margin-top:0">نموذج طلب موقع</h2>
      <p class="hint" id="reqHint">الحقول المعلَّمة بـ (*) مطلوبة. **الإرسال يتم إلى بريدك أولًا** عبر FormSubmit ثم إعادة التوجيه إلى صفحة الشكر.</p>

      <form id="siteForm"
            action="https://formsubmit.co/mshlool684@gmail.com"
            method="POST"
            novalidate autocomplete="on">
        <input id="hp" class="hp-trap" name="_honey" type="text" tabindex="-1" autocomplete="off" aria-hidden="true">
        <input type="hidden" name="_next" value="https://mohamad-alshlool03.github.io/Shlool-Web/thankyou.html">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_template" value="table">
        <input type="hidden" name="_subject" value="طلب جديد — Shlool Web">

        <!-- سيُملأ تلقائيًا قبل الإرسال -->
        <input type="hidden" name="orderId" id="orderIdField">
        <input type="hidden" name="summary" id="summaryField">
        <input type="hidden" name="page_url" value="https://mohamad-alshlool03.github.io/Shlool-Web/contact.html">

        <!-- معلومات أساسية -->
        <div class="grid-3">
          <div>
            <label for="fullName">الاسم الكامل *</label>
            <input id="fullName" name="fullName" required placeholder="مثال: محمد الشلول" autocomplete="name">
          </div>
          <div>
            <label for="phone">الهاتف / واتساب *</label>
            <input id="phone" name="phone" required placeholder="07X XXX XXXX" inputmode="tel" autocomplete="tel" dir="ltr">
            <p class="hint">أدخل رقم أردني بصيغة 07X XXX XXXX (077/078/079).</p>
          </div>
          <div>
            <label for="email">البريد الإلكتروني *</label>
            <input id="email" name="email" type="email" required placeholder="example@email.com" autocomplete="email" dir="ltr">
          </div>
        </div>

        <div class="grid-3" style="margin-top:12px">
          <div>
            <label for="business">اسم النشاط (اختياري)</label>
            <input id="business" name="business" placeholder="مثال: Falafel House" autocomplete="organization">
          </div>
          <div>
            <label for="industry">القطاع</label>
            <select id="industry" name="industry">
              <option value="">اختر…</option>
              <option>مطاعم وكافيهات</option>
              <option>عيادات ومراكز طبية</option>
              <option>شركات وبزنس</option>
              <option>متاجر إلكترونية</option>
              <option>شخصي/بورتفوليو</option>
              <option>تعليمي/تدريب</option>
              <option>غير ذلك</option>
            </select>
          </div>
          <div>
            <label for="currentSite">موقع حالي (إن وجد)</label>
            <input id="currentSite" name="currentSite" type="url" placeholder="https://example.com" dir="ltr" inputmode="url" autocomplete="url">
          </div>
        </div>

        <!-- نوع الموقع المطلوب -->
        <div style="margin-top:16px">
          <label for="siteType">نوع الموقع الذي تريده *</label>
          <select id="siteType" name="siteType" required aria-describedby="reqHint">
            <option value="">اختر نوع الموقع…</option>
            <option>موقع مطعم (منيو + QR)</option>
            <option>موقع عيادة (حجز مواعيد)</option>
            <option>موقع شركة/تعريفي</option>
            <option>متجر إلكتروني</option>
            <option>بورتفوليو شخصي</option>
            <option>صفحة هبوط</option>
            <option>آخر</option>
          </select>
          <p class="hint">سنضبط التصميم والمحتوى حسب النوع المختار.</p>
        </div>

        <!-- ميزات مطلوبة -->
        <div style="margin-top:10px">
          <label>الميزات المطلوبة (اختَر ما يلزم)</label>
          <div class="choices" id="featureChoices">
            <label><input name="features[]" type="checkbox" value="منيو أونلاين وQR"> منيو أونلاين وQR</label>
            <label><input name="features[]" type="checkbox" value="طلبات أونلاين بسيطة"> طلبات أونلاين بسيطة</label>
            <label><input name="features[]" type="checkbox" value="حجز مواعيد إلى الإيميل"> حجز مواعيد إلى الإيميل</label>
            <label><input name="features[]" type="checkbox" value="نموذج تواصل إلى الإيميل"> نموذج تواصل إلى الإيميل</label>
            <label><input name="features[]" type="checkbox" value="زر واتساب مباشر"> زر واتساب مباشر</label>
            <label><input name="features[]" type="checkbox" value="خرائط جوجل وموقع الفرع"> خرائط جوجل وموقع الفرع</label>
            <label><input name="features[]" type="checkbox" value="تعدد اللغات"> تعدد اللغات</label>
            <label><input name="features[]" type="checkbox" value="مدونة/مقالات"> مدونة/مقالات</label>
            <label><input name="features[]" type="checkbox" value="معرض صور/أعمال"> معرض صور/أعمال</label>
            <label><input name="features[]" type="checkbox" value="دفع أونلاين"> دفع أونلاين</label>
            <label><input name="features[]" type="checkbox" value="تأمين دومين واستضافة"> تأمين دومين واستضافة</label>
            <label><input name="features[]" type="checkbox" value="تحسين سرعة وSEO أساسي"> تحسين سرعة وSEO أساسي</label>
          </div>
        </div>

        <!-- الباقة المقترحة -->
        <div class="panel estimator reveal" id="estimator" style="margin-top:12px" aria-live="polite">
          <div>
            <strong>الباقة المقترحة:</strong>
            <span id="recName" class="estimate-pill">—</span>
            <span class="small" id="recReason"></span>
          </div>
          <div>
            <span class="small">سعر مبدئي:</span>
            <strong id="recPrice">—</strong>
          </div>
        </div>

        <!-- تفضيلات تصميم وهوية -->
        <div class="grid-3" style="margin-top:16px">
          <div>
            <label for="brandColor">اللون الأساسي المفضّل</label>
            <input id="brandColor" name="brandColor" type="color" value="#0a84ff" style="height:44px;padding:4px">
          </div>
          <div>
            <label for="stylePref">ستايل التصميم</label>
            <select id="stylePref" name="stylePref">
              <option value="">اختر…</option>
              <option>مودرن وبسيط</option>
              <option>كلاسيك/رسمي</option>
              <option>داكن</option>
              <option>فاتح</option>
            </select>
          </div>
          <div>
            <label for="assetsLink">رابط ملفات المحتوى</label>
            <input id="assetsLink" name="assetsLink" type="url" placeholder="Drive / Dropbox link" dir="ltr" inputmode="url" autocomplete="url">
          </div>
        </div>

        <!-- مواقع مرجعية + وقت التواصل -->
        <div class="grid-2" style="margin-top:12px">
          <div>
            <label for="ref1">موقع يعجبك (1)</label>
            <input id="ref1" name="ref1" type="url" placeholder="https://…" dir="ltr" inputmode="url" autocomplete="url">
          </div>
          <div>
            <label for="ref2">موقع يعجبك (2)</label>
            <input id="ref2" name="ref2" type="url" placeholder="https://…" dir="ltr" inputmode="url" autocomplete="url">
          </div>
        </div>

        <div class="grid-2" style="margin-top:12px">
          <div>
            <label for="contactTime">وقت التواصل المفضّل</label>
            <input id="contactTime" name="contactTime" type="text" placeholder="مثال: 5–8 مساءً" autocomplete="off">
          </div>
          <div>
            <label for="contactPref">طريقة التواصل المفضلة</label>
            <select id="contactPref" name="contactPref">
              <option value="">اختر…</option>
              <option>واتساب</option>
              <option>اتصال هاتفي</option>
              <option>بريد إلكتروني</option>
            </select>
          </div>
        </div>

        <!-- ملاحظات -->
        <div style="margin-top:16px">
          <label for="notes">ملاحظات إضافية</label>
          <textarea id="notes" name="notes" rows="6" placeholder="اكتب أي تفاصيل إضافية ترغب بها…" dir="auto"></textarea>
        </div>

        <!-- سياسة خصوصية -->
        <div class="actions" style="margin-top:6px">
          <label class="agree">
            <input id="agree" name="agree" type="checkbox" required>
            <span>أوافق على سياسة الخصوصية واستخدام بيانات التواصل للرد على الطلب.</span>
          </label>
        </div>

        <!-- إرسال -->
        <div class="actions">
          <button type="submit" class="btn"><span>إرسال الطلب</span></button>
          <button type="button" id="copySummary" class="btn btn-outline">نسخ الطلب</button>
          <button type="button" id="clearForm" class="btn btn-outline" title="مسح الحقول">تنظيف</button>
          <a class="btn btn-outline" href="index.html">رجوع للرئيسية</a>
        </div>
      </form>
    </section>
  </main>

  <footer>
    <div class="footer-inner">
      <div class="brand">© Shlool Web — جميع الحقوق محفوظة</div>
      <div style="display:flex; gap:10px; align-items:center">
        <div class="dev">تم التطوير من قبل محمد الشلول</div>
        <a class="btn btn-whatsapp" href="https://wa.me/962790986908" target="_blank" rel="noopener">واتساب: 0790986908</a>
      </div>
    </div>
  </footer>

  <script>
    // === إعدادات الويب آب (تم لصق الرابط) ===
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwDYQZgMCa3OGXNLvtNGJ9KDeI06AthQKpWrip27puCvDI7St9O3OExaekI3in1pH9brw/exec';
    const WEB_APP_TOKEN = 'Mohamad&03';

    // كشف ناعم
    const io = new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); } }); },{threshold:.08});
    document.querySelectorAll('.reveal').forEach(el=>io.observe(el));
    const $ = id => document.getElementById(id);

    // ميزات + توصية
    function getSelectedFeatures(){ return Array.from(document.querySelectorAll('#featureChoices input:checked')).map(c=>c.value); }
    function getRecommendation(){
      const f=getSelectedFeatures();
      let plan='الأساسية', price='70 د.أ', reason='موقع تعريفي وميزات أساسية.';
      if(f.includes('دفع أونلاين')){ plan='المتقدمة'; price='270 د.أ'; reason='يتضمن دفع أونلاين وتكاملات.'; }
      else{
        const group=['منيو أونلاين وQR','حجز مواعيد إلى الإيميل','طلبات أونلاين بسيطة','معرض صور/أعمال','مدونة/مقالات','تعدد اللغات','تأمين دومين واستضافة'];
        const count=f.filter(x=>group.includes(x)).length;
        if(count>=2){ plan='برو'; price='170 د.أ'; reason=`اخترت ${count} ميزات متقدمة.`; }
      }
      return {plan, price, reason};
    }
    function updateEstimator(){ const r=getRecommendation(); $('recName').textContent=r.plan; $('recPrice').textContent=r.price; $('recReason').textContent=r.reason; }
    document.querySelectorAll('#featureChoices input, #siteType').forEach(el=> el.addEventListener('change', updateEstimator));
    updateEstimator();

    // UTM
    const utm=(()=>{ const p=new URLSearchParams(location.search);
      const keys=['utm_source','utm_medium','utm_campaign','utm_content','utm_term']; const obj={};
      keys.forEach(k=>{ if(p.get(k)) obj[k]=p.get(k); }); return obj; })();

    // Jordan phone formatting
    function formatJordanPhone(value){
      const digits=(value||'').replace(/\D/g,'').replace(/^00/, '0');
      let d=digits;
      if(d.startsWith('962')) d='0'+d.slice(3);
      if(d.startsWith('0962')) d='0'+d.slice(4);
      if(d.startsWith('+962')) d='0'+d.slice(4);
      if(d.length>10) d=d.slice(0,10);
      if(d.length>3 && d.length<=6) d=d.slice(0,3)+' '+d.slice(3);
      else if(d.length>6) d=d.slice(0,3)+' '+d.slice(3,6)+' '+d.slice(6);
      return d;
    }
    function isValidJordanPhone(raw){
      const d=raw.replace(/\D/g,'').replace(/^00/, '0').replace(/^(\+)?962/, '0');
      return /^07(7|8|9)\d{7}$/.test(d);
    }
    const phoneInput=$('phone');
    phoneInput.addEventListener('input', ()=>{ const pos=phoneInput.selectionStart; const beforeLen=phoneInput.value.length; phoneInput.value=formatJordanPhone(phoneInput.value); const afterLen=phoneInput.value.length; const delta=afterLen-beforeLen; phoneInput.setSelectionRange(Math.max(0,(pos+delta)), Math.max(0,(pos+delta))); });
    phoneInput.addEventListener('blur', ()=>{ phoneInput.value=formatJordanPhone(phoneInput.value); });

    // ملخص
    function buildSummary(orderId){
      const name=$('fullName').value.trim();
      const phone=$('phone').value.trim();
      const email=$('email').value.trim();
      const business=$('business').value.trim();
      const industry=$('industry').value;
      const currentSite=$('currentSite').value.trim();
      const siteType=$('siteType').value;
      const features=getSelectedFeatures();
      const contactPref=$('contactPref').value;
      const notes=$('notes').value.trim();
      const contactTime=$('contactTime').value.trim();
      const stylePref=$('stylePref').value;
      const brandColor=$('brandColor').value;
      const assetsLink=$('assetsLink').value.trim();
      const refs=[$('ref1').value.trim(), $('ref2').value.trim()].filter(Boolean);
      const rec=getRecommendation();

      const lines=[];
      lines.push(`رقم الطلب: ${orderId}`);
      lines.push('طلب موقع جديد:');
      lines.push(`الاسم: ${name}`);
      lines.push(`الهاتف/واتساب: ${phone}`);
      lines.push(`البريد: ${email}`);
      if(business) lines.push(`النشاط: ${business}`);
      if(industry) lines.push(`القطاع: ${industry}`);
      if(currentSite) lines.push(`موقع حالي: ${currentSite}`);
      lines.push(`نوع الموقع: ${siteType || '-'}`);
      if(features.length) lines.push(`ميزات مطلوبة: ${features.join('، ')}`);
      if(stylePref) lines.push(`ستايل التصميم: ${stylePref}`);
      if(brandColor) lines.push(`لون العلامة: ${brandColor}`);
      if(assetsLink) lines.push(`رابط الملفات: ${assetsLink}`);
      if(refs.length) lines.push(`مواقع مرجعية: ${refs.join(' , ')}`);
      if(contactTime) lines.push(`وقت التواصل المفضّل: ${contactTime}`);
      if(contactPref) lines.push(`طريقة التواصل: ${contactPref}`);
      lines.push(`الباقة المقترحة: ${rec.plan} — سعر مبدئي: ${rec.price}`);
      if(notes){ lines.push(''); lines.push('ملاحظات إضافية:'); lines.push(notes); }
      if(Object.keys(utm).length){ lines.push(''); lines.push('وسوم UTM:'); lines.push(JSON.stringify(utm)); }
      return lines.join('\n');
    }

    function saveSummaryForThankYou(orderId, summary){
      const data = {
        fullName: ($('fullName')?.value||'').trim(),
        phone: ($('phone')?.value||'').trim(),
        email: ($('email')?.value||'').trim(),
        business: ($('business')?.value||'').trim(),
        industry: ($('industry')?.value||''),
        currentSite: ($('currentSite')?.value||'').trim(),
        siteType: ($('siteType')?.value||''),
        features: getSelectedFeatures(),
        stylePref: ($('stylePref')?.value||''),
        brandColor: ($('brandColor')?.value||''),
        assetsLink: ($('assetsLink')?.value||'').trim(),
        ref1: (document.getElementById('ref1')?.value||'').trim(),
        ref2: (document.getElementById('ref2')?.value||'').trim(),
        contactTime: ($('contactTime')?.value||'').trim(),
        contactPref: ($('contactPref')?.value||''),
        notes: ($('notes')?.value||'').trim()
      };
      sessionStorage.setItem('orderId', orderId);
      sessionStorage.setItem('orderSummary', summary);
      sessionStorage.setItem('orderData', JSON.stringify(data));
    }

    // Required fields
    function setInvalid(el, on){
      el.classList.toggle('invalid', on);
      if(on){
        const clear = () => el.classList.remove('invalid');
        el.addEventListener('input', clear, {once:true});
        el.addEventListener('change', clear, {once:true});
      }
    }
    function validateRequired(){
      const req=['fullName','phone','email','siteType','agree']; let ok=true;
      req.forEach(id=>{
        const el=$(id);
        let empty=(el.type==='checkbox' ? !el.checked : !el.value.trim());
        if(id==='phone' && !empty && !isValidJordanPhone(el.value)) empty=true;
        setInvalid(el, empty); if(empty) ok=false;
      });
      if($('hp').value.trim()){ ok=false; alert('تم إيقاف الإرسال (مرشح سبام).'); }
      return ok;
    }

    // حفظ تلقائي
    const LS_KEY='siteFormData';
    function saveForm(){
      const data={};
      document.querySelectorAll('#siteForm input, #siteForm select, #siteForm textarea').forEach(el=>{
        if(el.id==='hp') return;
        if(el.type==='checkbox' && el.closest('#featureChoices')) return;
        data[el.id]=(el.type==='checkbox')?el.checked:el.value;
      });
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }
    function restoreForm(){
      const raw=localStorage.getItem(LS_KEY); if(!raw) return;
      try{
        const data=JSON.parse(raw);
        Object.entries(data).forEach(([id,val])=>{ const el=$(id); if(el) el.type==='checkbox'? el.checked=!!val : el.value=val??''; });
      }catch{}
      updateEstimator();
    }
    function clearForm(){
      document.getElementById('siteForm').reset();
      localStorage.removeItem(LS_KEY);
      document.querySelectorAll('.invalid').forEach(el=>el.classList.remove('invalid'));
      updateEstimator();
    }
    restoreForm();
    document.getElementById('siteForm').addEventListener('input', saveForm);
    document.getElementById('clearForm').addEventListener('click', clearForm);

    // توليد رقم الطلب
    function generateOrderId(){
      const d = new Date();
      const y = String(d.getFullYear()).slice(-2);
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const bytes = new Uint8Array(3); crypto.getRandomValues(bytes);
      const rand = Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase().slice(0,5);
      return `SH-${y}${m}${day}-${rand}`;
    }

    // الإرسال
    document.getElementById('siteForm').addEventListener('submit', function(e){
      if(!validateRequired()){ e.preventDefault(); return; }

      const orderId = generateOrderId();
      const summary = buildSummary(orderId);

      // خزّن للـ thankyou
      saveSummaryForThankYou(orderId, summary);

      // مرّر لـ FormSubmit
      document.getElementById('orderIdField').value = orderId;
      document.getElementById('summaryField').value = summary;

      // إرسال نسخة للـ Web App (Apps Script)
      try{
        const payload = {
          token: WEB_APP_TOKEN,
          orderId,
          status: 'received',
          fullName: (document.getElementById('fullName')?.value||'').trim(),
          phone: (document.getElementById('phone')?.value||'').trim(),
          email: (document.getElementById('email')?.value||'').trim(),
          notes: (document.getElementById('notes')?.value||'').trim()
        };
        const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
        const sent = navigator.sendBeacon && navigator.sendBeacon(WEB_APP_URL, blob);
        if(!sent){
          fetch(WEB_APP_URL, {
            method:'POST', mode:'cors', keepalive:true,
            headers:{ 'Content-Type':'application/json', 'x-shlool-key': WEB_APP_TOKEN },
            body: JSON.stringify(payload)
          }).catch(()=>{});
        }
        sessionStorage.setItem(`status:${orderId}`,'received');
      }catch(err){ console.warn('Beacon/Fetch to Web App failed:', err); }
    });

    // نسخ الملخص يدويًا
    document.getElementById('copySummary').addEventListener('click', async function(){
      const tmp = buildSummary('—');
      try{ await navigator.clipboard.writeText(tmp); alert('تم نسخ الطلب إلى الحافظة ✅'); }
      catch{ alert('لم نتمكّن من النسخ تلقائيًا. انسخ يدويًا بعد تحديد النص.'); }
    });
  </script>
</body>
</html>
