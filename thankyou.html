<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تفاصيل طلبك — Shlool Web</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#1f1f1f; --card:#262626; --text:#e9ecf1; --muted:#b7c0cc; --blue:#0a84ff; --max:1000px;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px; --border:rgba(255,255,255,.08);
      --accent: var(--blue);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -100px, rgba(64,179,255,.12), transparent 60%),
        linear-gradient(180deg, #1b1b1b, var(--bg));
    }
    .wrap{max-width:var(--max); margin:auto; padding:40px 20px}
    .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:22px; box-shadow:var(--shadow)}
    h1{margin:0 0 14px; font-size:clamp(26px,4vw,38px)}
    h2{margin:0 0 12px; font-size:clamp(20px,3vw,26px)}
    p{color:var(--muted); margin:0 0 16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:800px){ .grid{grid-template-columns:1fr} }
    .row{display:flex; gap:10px; align-items:flex-start; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.02)}
    .key{min-width:170px; font-weight:800; color:#fff}
    .val{color:var(--muted); overflow-wrap:anywhere}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border);
         background:linear-gradient(135deg,var(--blue),#40b3ff); color:#fff; font-weight:800; text-decoration:none; box-shadow:var(--shadow); cursor:pointer}
    .btn.ghost{background:transparent; color:var(--text)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; background:#1f1f1f; padding:12px; border-radius:12px; border:1px solid var(--border)}
    .note{color:var(--muted); font-size:13px}
    .badge{display:inline-flex; align-items:center; gap:8px; font-weight:800; padding:6px 10px; border-radius:999px;
           background:rgba(255,255,255,.06); border:1px solid var(--border); color:#fff; font-size:14px}
    .thanks{position:relative; overflow:hidden}
  </style>
</head>
<body>
  <main class="wrap">
    <!-- تفاصيل الطلب -->
    <section class="panel" aria-labelledby="detailsTitle">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <h1 id="detailsTitle" style="margin-bottom:0">تفاصيل الطلب</h1>
        <div class="badge" id="orderBadge" title="رقم الطلب">رقم الطلب: <span id="orderId">—</span></div>
      </div>
      <p>راجع الملخّص أدناه. تقدر تنسخه أو تطبعه لو حبيت.</p>

      <div class="grid" id="detailsGrid" hidden></div>

      <div style="margin-top:12px">
        <h2 style="margin-top:0">الملخّص النصّي</h2>
        <div id="summaryBox" class="mono">—</div>
      </div>

      <div class="btns">
        <button class="btn" id="copyBtn">نسخ الملخّص</button>
        <button class="btn ghost" id="printBtn">طباعة</button>
        <button class="btn ghost" id="downloadBtn">تنزيل TXT</button>
        <a class="btn ghost" href="contact.html">تعديل الطلب</a>
      </div>

      <p class="note">* لو ما ظهر شيء، تأكد إنك أرسلت الطلب من صفحة التواصل نفسها.</p>
    </section>

    <!-- رسالة الشكر -->
    <section class="panel thanks" id="thanksPanel" style="margin-top:18px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <h2 style="margin:0; color:inherit">شكرًا! ✅</h2>
        <div class="badge" aria-hidden="true">#<span id="orderIdMirror">—</span></div>
      </div>
      <p id="thanksText" style="color:inherit">استلمنا تفاصيل طلبك، ورح نراجعها ونرجع لك خلال وقت قصير.</p>

      <!-- أزرار تواصل جاهزة برسالة فيها رقم الطلب -->
      <div class="btns">
        <a class="btn" href="index.html">العودة للرئيسية</a>
        <a class="btn" id="whBtn" target="_blank" rel="noopener">إرسال عبر واتساب</a>
        <a class="btn ghost" id="mailBtn" target="_blank" rel="noopener">إرسال عبر الإيميل</a>
        <a class="btn" href="https://wa.me/962790986908" target="_blank" rel="noopener">تواصل واتساب</a>
      </div>

      <!-- QR + رابط تتبّع -->
      <div id="qrWrap" style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <div id="qrcode" style="width:140px; height:140px; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:12px; display:flex; align-items:center; justify-content:center">QR</div>
        <div style="max-width:520px">
          <p style="margin:0;color:inherit">امسح الـ QR لتتبّع طلبك مباشرة.</p>
          <a id="trackLink" class="btn ghost" href="#" target="_blank" rel="noopener">فتح صفحة التتبّع</a>
        </div>
      </div>
    </section>
  </main>

  <!-- مكتبة توليد QR خفيفة -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script>
    /* ===== أدوات مساعدة للألوان/التباين ===== */
    function sanitizeColor(input){
      if(!input) return null;
      const v = String(input).trim();
      if(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v)) return v;
      if(/^[a-zA-Z]+$/.test(v)) return v;
      return null;
    }
    function hexToRgb(hex){
      hex = hex.replace('#','');
      if(hex.length===3){ hex = hex.split('').map(c=>c+c).join(''); }
      const num = parseInt(hex,16);
      return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 };
    }
    function toRgbaStr(color, alpha){
      if(color.startsWith('#')){
        const {r,g,b} = hexToRgb(color);
        return `rgba(${r},${g},${b},${alpha})`;
      }
      return color;
    }
    function relativeLuminance({r,g,b}){
      const srgb = [r,g,b].map(v=>{
        v/=255;
        return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4);
      });
      return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
    }
    function getContrastText(color){
      if(color.startsWith('#')){
        const rgb = hexToRgb(color);
        const L = relativeLuminance(rgb);
        return (L > 0.35) ? '#000' : '#fff';
      }
      const lightNames = ['yellow','gold','khaki','lightyellow','lemonchiffon','lightgoldenrodyellow','papayawhip','moccasin'];
      return lightNames.includes(color.toLowerCase()) ? '#000' : '#fff';
    }
    function generateOrderId(){
      // مثال: SH-250928-4F7C2
      const d = new Date();
      const y = String(d.getFullYear()).slice(-2);
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const rand = (()=>{ 
        const bytes = new Uint8Array(3); crypto.getRandomValues(bytes);
        return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase().slice(0,5);
      })();
      return `SH-${y}${m}${day}-${rand}`;
    }

    /* ===== قراءة بيانات الطلب من sessionStorage ===== */
    const summary = sessionStorage.getItem('orderSummary') || '—';
    const dataRaw = sessionStorage.getItem('orderData');
    const data = dataRaw ? JSON.parse(dataRaw) : null;

    /* ===== رقم الطلب (توليد + حفظ) ===== */
    let orderId = sessionStorage.getItem('orderId');
    if(!orderId){ orderId = generateOrderId(); sessionStorage.setItem('orderId', orderId); }

    document.getElementById('orderId').textContent = orderId;
    document.getElementById('orderIdMirror').textContent = orderId;

    /* ===== الملخّص النصّي (مع إدراج رقم الطلب أعلى النص) ===== */
    const summaryBox = document.getElementById('summaryBox');
    const summaryWithId = `رقم الطلب: ${orderId}\n\n${summary}`;
    summaryBox.textContent = summaryWithId;

    /* ===== شبكة التفاصيل ===== */
    const grid = document.getElementById('detailsGrid');
    const labels = {
      orderId:'رقم الطلب',
      fullName:'الاسم الكامل', phone:'الهاتف/واتساب', email:'البريد الإلكتروني',
      business:'اسم النشاط', industry:'القطاع', currentSite:'موقع حالي',
      siteType:'نوع الموقع', features:'ميزات مطلوبة', stylePref:'ستايل التصميم',
      brandColor:'لون العلامة', assetsLink:'رابط الملفات',
      ref1:'موقع يعجبك (1)', ref2:'موقع يعجبك (2)',
      contactTime:'وقت التواصل', contactPref:'طريقة التواصل', notes:'ملاحظات'
    };
    function addRow(key, value){
      const wrap = document.createElement('div'); wrap.className='row';
      const k = document.createElement('div'); k.className='key'; k.textContent = key;
      const v = document.createElement('div'); v.className='val'; v.textContent = value;
      wrap.appendChild(k); wrap.appendChild(v); grid.appendChild(wrap);
    }
    let entries = [];
    entries.push(['رقم الطلب', orderId]);
    if(data){
      const mapped = Object.entries(labels)
        .filter(([k]) => k!=='orderId')
        .map(([k,lab]) => [lab, (k==='features' && Array.isArray(data[k])) ? data[k].join('، ') : (data[k]||'—')])
        .filter(([,val]) => String(val).trim() !== '');
      entries = entries.concat(mapped);
      entries.forEach(([lab,val])=> addRow(lab, val));
      if(entries.length){ grid.hidden = false; }
    } else {
      entries.forEach(([lab,val])=> addRow(lab, val));
      grid.hidden = false;
    }

    /* ===== أزرار: نسخ/طباعة/تنزيل ===== */
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(summaryWithId); alert('تم نسخ الملخّص ✅'); }
      catch{ alert('تعذّر النسخ التلقائي. انسخ يدويًا.'); }
    });
    document.getElementById('printBtn').addEventListener('click', ()=> window.print());
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const blob=new Blob([summaryWithId], {type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`order-${orderId}.txt`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    });

    /* ===== تلوين لوحة الشكر حسب brandColor ===== */
    const thanksPanel = document.getElementById('thanksPanel');
    const brand = sanitizeColor(data?.brandColor);
    const accent = brand || getComputedStyle(document.documentElement).getPropertyValue('--blue').trim();
    document.documentElement.style.setProperty('--accent', accent);
    const textColor = accent.startsWith('#') ? getContrastText(accent) : '#fff';
    const overlay1 = accent.startsWith('#') ? toRgbaStr(accent, 0.25) : 'rgba(64,179,255,0.20)';
    const overlay2 = accent.startsWith('#') ? toRgbaStr(accent, 0.45) : 'rgba(10,132,255,0.35)';
    thanksPanel.style.background = `linear-gradient(135deg, ${overlay1}, ${overlay2}), var(--card)`;
    thanksPanel.style.borderColor = accent;
    thanksPanel.style.color = textColor;
    document.getElementById('thanksText').style.color = textColor;

    /* ===== روابط واتساب + إيميل (تحتوي رقم الطلب والملخّص) ===== */
    const businessPhone = '962790986908'; // عدّل الرقم بدون +
    const orderShort = (summary || '').split('\n').slice(0,6).join('\n');
    const waMsg = `مرحبًا،\nأرسل لكم تفاصيل طلبي.\n${summaryWithId}\n\n— مقتطف —\n${orderShort}`;
    const waLink = `https://wa.me/${businessPhone}?text=${encodeURIComponent(waMsg)}`;
    document.getElementById('whBtn').href = waLink;

    const mailTo = (data?.email && String(data.email).trim()) || '';
    const subject = `طلب جديد — ${orderId}`;
    const body = `مرحبًا،\n\nتفاصيل الطلب:\n${summaryWithId}\n\nشكرًا.`;
    const mailLink = `mailto:${mailTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    document.getElementById('mailBtn').href = mailLink;

    /* ===== توليد رابط التتبّع + QR ===== */
    const trackUrl = `${location.origin}${location.pathname.replace(/[^/]+$/,'')}track.html?id=${encodeURIComponent(orderId)}`;
    document.getElementById('trackLink').href = trackUrl;
    try{
      document.getElementById('qrcode').textContent = '';
      new QRCode(document.getElementById("qrcode"), {
        text: trackUrl,
        width: 128,
        height: 128,
        correctLevel: QRCode.CorrectLevel.M
      });
    }catch(e){
      document.getElementById('qrcode').textContent = 'QR غير متاح';
    }
  </script>
</body>
</html>
